name: Notify Discord on PR Merge to Master

on:
  push:
    branches:
      - master

concurrency:
  group: merged-to-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  discord-notify:
    runs-on: ubuntu-latest
    steps:
      - name: Build commit URL
        id: commit_url
        run: |
          echo "url=${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Short SHA
        id: short_sha
        run: echo "value=${GITHUB_SHA::6}" >> $GITHUB_OUTPUT
      
      - name: Use it
        run: |
          echo "Commit: ${{ steps.commit_url.outputs.url }}"

      - name: Extract PR number from merge commit
        id: pr_number
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          COMMIT_MSG="${{ github.event.head_commit.message }}"
          echo "Commit message: $COMMIT_MSG"

          PR_NUMBER=$(echo "$COMMIT_MSG" | grep -oE 'pull request #[0-9]+' | grep -oE '[0-9]+')

          echo "PR number: $PR_NUMBER"
          echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT

      - name: Get PR title
        id: pr_title
        if: steps.pr_number.outputs.number != ''
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TITLE=$(gh api repos/${{ github.repository }}/pulls/${{ steps.pr_number.outputs.number }} --jq '.title')
          echo "Merged PR title: $TITLE"
          echo "title=$TITLE" >> $GITHUB_OUTPUT

      - name: Notify Discord
        uses: rjstone/discord-webhook-notify@v2
        with:
          webhookUrl: ${{ secrets.DISCORD_PR_WEBHOOK }}
          username: "MagBridge CI"
          avatarUrl: "https://raw.githubusercontent.com/mag-bros/mag-bridge/assets-v1.2/.github/assets/sukces.png"
          severity: info
          color: "#ba005b"
          title: "ğŸ™ˆ Pull Request merged into '${{ github.ref_name }}'"
          description: |
            **Author:** `${{ github.event.pusher.name }}`
          details: |
            ğŸ“ **PR Title:** ${{ steps.pr_title.outputs.title }}
            âœ¨ **PR Number:** ${{ steps.pr_number.outputs.number }}
            ğŸ”— **Commit Reference:** [${{ steps.short_sha.outputs.value }}](${{ steps.commit_url.outputs.url }})
          footer: "MagBridge CI â€¢ ${{ github.event.head_commit.timestamp }}"
