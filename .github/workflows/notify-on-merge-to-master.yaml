name: Notify Discord on Master Branch Change

on:
  push:
    branches:
      - master

concurrency:
  group: merged-to-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  discord-notify:
    runs-on: ubuntu-latest
    steps:
      - name: Build commit URL
        id: commit_url
        run: |
          echo "url=${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}" >> $GITHUB_OUTPUT

      - name: Short SHA
        id: short_sha
        run: echo "value=${GITHUB_SHA::8}" >> $GITHUB_OUTPUT
      
      - name: Use it
        run: |
          echo "Commit: ${{ steps.commit_url.outputs.url }}"

      - name: PR number ("empty" on direct commits)
        id: pr
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          pr='${{ github.event.pull_request.number }}'
          [ -z "$pr" ] && pr="$(gh api "/repos/$GITHUB_REPOSITORY/commits/$GITHUB_SHA/pulls" --jq '.[0].number // empty')"
          [ -z "$pr" ] && pr="empty"
          echo "number=$pr" >> "$GITHUB_OUTPUT"

      - name: Build change summary (PR title or commit message)
        id: change
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          PR="${{ steps.pr_number.outputs.number }}"
          if [ -n "$PR" ] && [ "$PR" != "empty" ]; then
            TEXT="ğŸ“ **PR Title:** $(gh api "repos/${{ github.repository }}/pulls/$PR" --jq '.title')"
          else
            TEXT="ğŸ“ **Commit message:** ${{ github.event.head_commit.message }}"
          fi
      
          {
            echo "text<<EOF"
            echo "$TEXT"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Notify Discord
        uses: rjstone/discord-webhook-notify@v2
        with:
          webhookUrl: ${{ secrets.DISCORD_PR_WEBHOOK }}
          username: "MagBridge CI"
          avatarUrl: "https://raw.githubusercontent.com/mag-bros/mag-bridge/assets-v1.2/.github/assets/sukces.png"
          severity: info
          color: "#ba005b"
          title: "ğŸ™ˆ Pull Request merged to '${{ github.ref_name }}'"
          description: |
            **Author:** `${{ github.event.pusher.name }}`
          details: |
            ${{ steps.change.outputs.text }}
            âœ¨ **PR Number:** ${{ steps.pr.outputs.number }}
            ğŸ”— **Commit Reference:** [${{ steps.short_sha.outputs.value }}](${{ steps.commit_url.outputs.url }})
          footer: "MagBridge CI â€¢ ${{ github.event.head_commit.timestamp }}"
